<!DOCTYPE html>
<html>
  <head>
    <title>arTV</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="snow.js"></script>
    <script>

      var art = [];
      var timer;
      var rotationSpeed = 4*60;  // <<== change this to however long you want to show each image, in minutes
      var debug = false;
      var showClock = true;
      var clockInterval;


      function loadConfiguration ( path ) {
        // attempt to load configuration from a file
        fetch('art/config.json')
          .then(response => {
            if (!response.ok) {
              if (debug) console.log('Configuration: Additional configuration not available in "'+path+'".');
            }
            return response.json();
          })
          .then(data => {
            for (const key in data) {
              if (data.hasOwnProperty(key)) {
                switch (key) {
                  case 'debug':
                  case 'showClock':
                  case 'rotationSpeed':
                    window[key]=data[key];
                    if (debug) console.log("Configuration: "+key+" set to "+data[key]);
                    break;
                  default:
                    if (debug) console.warn(`Configuration: Unrecognized '${key}' value found in configuration file and ignored.`);
                    break;
                }
              }
            }
          })
          .catch(error => {
            console.warn('Configuration: Could not load configuration from "'+path+'".');
          });
      }


      function loadArt () {
        // TODO if the preload image has no source, use the default artv image
        if (debug) console.log("----------\nSetting the (background) image to be what was preloaded: "+$('IMG#preload').attr('src'));

        // set the background image to be what was preloaded
        $('#fader').fadeIn(1000,function () {
          $('BODY').css('background-image','url("' + $('IMG#preload').attr('src') + '")');
          checkForSnow();  // check to see if snow should be added
          preloadArt();
          $('#fader').fadeOut(1000);
        });
      }


      function preloadArt () {
        // if no art is available, use the default ArTV image
        if ( art.length == 0 ) {
          if (debug) console.log("There was no art available, so I'm using the default instead.");
          $('IMG#preload').attr('src',("artv.jpg"));
          return;
        }

        // preload the next random image
        if (debug) console.log(art);
        let randomIndex = Math.floor(Math.random() * art.length);
        if (debug) console.log("There were "+art.length+" image options provided by the API and I picked number "+randomIndex+" which is: "+art[randomIndex]);
        //$('IMG#preload').attr('src',encodeURIComponent(art[randomIndex]));  // does it need to be encoded?
        $('IMG#preload').attr('src',(art[randomIndex]));
        if (debug) console.log("The current (background) image is "+$('BODY').css('background-image')+". The next (preload) image is "+$('IMG#preload').attr('src'));
      }


      function loadImages () {
        // get the available images
        $.ajax({
          url: 'api.php',
          method: 'GET',
          success: function(data) {
            if ( !Array.isArray(data) || data.length == 0 ) {
              console.log("Welcome to ArTV! Please add images to the 'art' folder for display.");  // must be new install?
            } else {
              art = data;
              setTimeout(loadArt,1000*7); // just show the logo for 5 seconds
              timer = setInterval(loadArt,1000*60*rotationSpeed); // set a timeout to pick another random image and dispay that
            }
            loadArt();
          },
          error: function(data) {
            console.warn("Welcome to ArTV! There seems to be a problem with the API :( Can you take a look into that?");  // must be new install?
            loadArt();
          }
        });
      }


      function clockUpdate () {
        // Update the clock with the latest time
        const now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        minutes = minutes < 10 ? '0'+minutes : minutes;
        let seconds = now.getSeconds();
        seconds = seconds < 10 ? '0'+seconds : seconds;
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12;
        $("DIV#clock").html(hours+':'+minutes+'<span class="ampm">'+ampm+'</span>');
      }


      // when the document is loaded
      $(document).ready(function() {
        loadConfiguration('art/config.json');

        loadImages();

        // change the art on mouse click
        $(document).click(function(event) {
          loadArt();
        });

        // show and update the clock
        if ( showClock ) {
          $("DIV#clock").show();
          clockInterval = setInterval(clockUpdate,300);
        }

        // Change the art on keypress or click
        $(document).keyup(function(event) {
          if (debug) console.log("A key was pressed: "+event.which);
          if ( event.which == 16 ) { // shift
            // do nothing, likely just a force-refresh on the browser
          } else if ( event.which == 68 ) { // Toggle debug "d"
            console.log("Toggling the display of debug information.");
            if ( debug ) debug = false;
            else debug = true;
          } else if ( event.which == 80 ) {  // Toggle showing the preview "p"
            console.log("Toggling the display of the preview image.");
            if ( $("IMG#preload").hasClass("show") ) $("IMG#preload").removeClass("show");
            else $("IMG#preload").addClass("show");
          } else if ( event.which == 67 ) {  // Toggle showing the clock "c"
            console.log("Toggling the display of the clock.");
            if ( $('DIV#clock').is(':visible') ) {
              $('DIV#clock').hide();
              clearInterval(clockInterval);
            } else {
              $('DIV#clock').show();
              clockInterval = setInterval(clockUpdate,300);
            }
          } else {
            loadArt();
          }
        });

      });

    </script>

    <link rel="stylesheet" href="snow.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
      HTML { cursor: none; }
      BODY { margin: 0; padding: 0; background-color: #000; background-size: cover; background-repeat: no-repeat; background-attachment: fixed; background-position: center center; }
      BODY DIV#snow { z-index: 10; }
      BODY DIV#fader { position: fixed; height: 100%; width: 100%; margin: 0; background: #111; z-index: 100; }
      BODY IMG#preload { display: none; }
      BODY IMG#preload.show { display: block; position: fixed; top: 0; right: 0; width: 100px; border: 5px solid #ffffff; margin: 1vw; box-shadow: 5px 5px 10px; }
      BODY DIV#clock { display: none; position: fixed; right: 1vw; bottom: 1vw; text-align: right; font-family: 'Oswald', sans-serif; font-size: 90px; line-height: 90px; font-weight: 700; color: rgba(255, 255, 255, 0.3); -webkit-text-stroke: 1px rgba(0,0,0,0.3); z-index: 200; height: 90px; overflow: hidden; }
      BODY DIV#clock .ampm { font-size: 50px; }
    </style>
  </head>
  <body>
    <div id="fader"></div>
    <img id="preload" src="artv.png" />
    <div id="snow"></div>
    <div id="clock"></div>
  </body>
</html>
